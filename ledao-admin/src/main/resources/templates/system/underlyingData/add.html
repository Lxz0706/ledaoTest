<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增底层资料')" />
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-underlyingdata-add">
        <input name="projectId" type="hidden" th:value="${projectId}"/>
        <div class="form-group">
            <label class="col-sm-3 control-label">文件名称：</label>
            <div class="col-sm-8">
                <input name="file" id="file" type="file" multiple="multiple">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">创建人名称：</label>
            <div class="col-sm-8">
                <input name="createor" class="form-control" type="text">
            </div>
        </div>
    </form>
</div>
<th:block th:include="include :: footer" />
<script type="text/javascript">
    var prefix = ctx + "system/underlyingdata"
    $("#form-underlyingdata-add").validate({
        focusCleanup: true
    });

    function submitHandler() {
        var form = document.getElementById("form-underlyingdata-add")//先获到表单的JQ对象
        formData = new FormData(form);
        //formData.append("file", obj);
        // 禁用按钮
        // $.modal.disable();
        var str = "";
        $.ajax({
            url: prefix + "/add",
            type: "post",
            data: formData,
            processData: false,
            contentType: false,
            xhr: xhrOnProgress(function (e) {
                $("#loaderCenter").show();
                var percent = 100 * e.loaded / e.total; //文件上传百分比
                $("#loader").html(parseInt(percent) + "%") //数字百分比
                var loaderbox = document.getElementById('loader');
                //进度条宽度百分比
                loaderbox.style.width = parseInt(percent) + "%";
                //str += parseInt(percent) + "%";
            }),
            success: function (result) {
                $("#loaderCenter").hide();
                //$.modal.closeLoading();
                $.operate.successCallback(result);
            }
        })
    }

    // 上传进度
    var xhrOnProgress = function (fun) {
        xhrOnProgress.onprogress = fun; //绑定监听
        //使用闭包实现监听绑
        return function () {
            //通过$.ajaxSettings.xhr();获得XMLHttpRequest对象
            var xhr = $.ajaxSettings.xhr();
            //判断监听函数是否为函数
            if (typeof xhrOnProgress.onprogress !== 'function')
                return xhr;
            //如果有监听函数并且xhr对象支持绑定时就把监听函数绑定上去
            if (xhrOnProgress.onprogress && xhr.upload) {
                xhr.upload.onprogress = xhrOnProgress.onprogress;
            }
            return xhr;
        }
    }
</script>
</body>
</html>