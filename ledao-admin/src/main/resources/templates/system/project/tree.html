<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<th:block th:include="include :: header('人员选择')"/>
<link th:href="@{/ajax/libs/jquery-ztree/3.5/css/metro/zTreeStyle.css}" rel="stylesheet"/>
<style>
    body {
        height: auto;
        font-family: "Microsoft YaHei";
    }

    button {
        font-family: "SimSun", "Helvetica Neue", Helvetica, Arial;
    }
</style>
<body class="hold-transition box box-main">

<input id="selectedProjectIds" name="selectedProjectIds" type="hidden" th:value="${selectedProjectIds}"/>
<input id="selectedProjectNames" name="selectedProjectNames" type="hidden" th:value="${selectedProjectNames}"/>
<input id="multiSelectFlag" name="multiSelectFlag" type="hidden" th:value="${multiSelectFlag}"/>
<input id="role" type="text" th:value="${role}"/>

<div class="row">
    <div class="col-xs-10">
        <div class="treeSearchInput" id="search">
            <label>姓名：</label><input type="text" class="empty" id="projectName" name="projectName" maxlength="50"/>
            <button class="btn" id="btn" onclick="loadUserList()"> 搜索</button>
        </div>
    </div>
</div>
<div class="container-div">
    <div class="row">
        <div class="col-xs-4" style="padding-top: 10px;">
            <h4>待选项目</h4>
            <select name="from" id="multiselect" class="js-multiselect form-control" size="15"
                    multiple="multiple"></select>
        </div>

        <div class="col-xs-1" style="padding-top: 40px;">
            <button type="button" id="multiselect_rightAll" class="btn btn-block"><i
                    class="glyphicon glyphicon-forward"></i></button>
            <button type="button" id="multiselect_rightSelected" class="btn btn-block"><i
                    class="glyphicon glyphicon-chevron-right"></i></button>
            <button type="button" id="multiselect_leftSelected" class="btn btn-block"><i
                    class="glyphicon glyphicon-chevron-left"></i></button>
            <button type="button" id="multiselect_leftAll" class="btn btn-block"><i
                    class="glyphicon glyphicon-backward"></i></button>
        </div>

        <div class="col-xs-4" style="padding-top: 10px;">
            <h4>已选项目</h4>
            <select name="to" id="multiselect_to" class="form-control" size="15" multiple="multiple"></select>
        </div>
    </div>
</div>

<div th:include="include::footer"></div>
<script th:src="@{/ajax/libs/jquery-ztree/3.5/js/jquery.ztree.all-3.5.js}"></script>
<script th:inline="javascript">
    $(function () {
        /*$('input[name="customerName"]').on('input propertychange', function () {
            loadUserList();
        });*/

        //获取多选标记
        var multiSelectFlag = $("#multiSelectFlag").val();

        //如果是非多选，进行如下处理，变成单选
        if (!multiSelectFlag || multiSelectFlag != 'true') {
            $("#multiselect_rightSelected").click(function () {
                var checkValue = $("#multiselect").val();
                if (checkValue != '' || checkValue != null) {
                    $("#multiselect_to option").each(function () {  //遍历所有option
                        var val = $(this).val();   //获取option值
                        var text = $(this).text(); //获取option文本内容
                        if (val != '' && val != null && val != undefined && text != '' && text != null && text != undefined) {
                            $("#multiselect").append("<option value='" + val + "'>" + text + "</option>");
                        }
                    });
                    $("#multiselect_to").find("option").remove();
                }
            });

            $("#multiselect_rightAll").hide();
            $("#multiselect_leftAll").hide();
        }

        //1、初始化左右员工选择器
        $('#multiselect').multiselect({
            includeSelectAllOptions: true
        });

        //2、加载已被选择的人员
        var selectedProjectIds = $("#selectedProjectIds").val();
        var selectedProjectNames = $("#selectedProjectNames").val();

        if (selectedProjectIds != '' && selectedProjectIds != null && selectedProjectIds != undefined) {
            var idsArray = selectedProjectIds.split(",");
            var namesArray = selectedProjectNames.split(",");
            for (var i = 0; i < idsArray.length; i++) {
                $("#multiselect_to").append("<option value='" + idsArray[i] + "'>" + namesArray[i] + "</option>");
            }
        }

        //3、加载所有人员列表
        loadUserList();

    });

    //加载人员方法
    function loadUserList(deptId) {

        //清空当前待选择人员框列表
        $("#multiselect").find("option").remove();

        var customerName = $("#customerName").val();
        var role = $("#role").val();

        var selectedProjectIds = "";

        //获取当前已选人员ids,用于过滤
        $("#multiselect_to option").each(function () {  //遍历所有option
            var val = $(this).val();   //获取option值
            if (val != '') {
                selectedProjectIds = selectedProjectIds + val + ",";
            }
        });

        //加载待选人员数据
        if (role == thb) {
            $.ajax({
                type: "get",
                url: ctx + "system/project/listForTree",
                traditional: true,
                dataType: "json",
                data: {},
                success: function (result) {
                    for (var i = 0; i < result.sysCustomerList.length; i++) {//加载未拥有的角色  这里根据后台传递的对象循环添加
                        //与当前所选人员进行对比，待选人员中过滤掉已选的人员
                        if (selectedProjectIds != '') {
                            var idsArray = selectedProjectIds.split(",");
                            var flag = true;
                            for (var k = 0; k < idsArray.length; k++) {
                                if (idsArray[k] == result.sysCustomerList[i].userId) {
                                    flag = false;
                                }
                            }
                            if (flag) {
                                $("#multiselect").append("<option value='" + result.sysCustomerList[i].projectId + "'>" + result.sysCustomerList[i].projectName + "</option>");
                            }
                        } else {
                            $("#multiselect").append("<option value='" + result.sysCustomerList[i].projectId + "'>" + result.sysCustomerList[i].projectName + "</option>");
                        }
                    }
                }
            });
        } else if (role == tzb) {
            $.ajax({
                type: "get",
                url: ctx + "system/zcb/zck/listForTree",
                traditional: true,
                dataType: "json",
                data: {},
                success: function (result) {
                    for (var i = 0; i < result.sysCustomerList.length; i++) {//加载未拥有的角色  这里根据后台传递的对象循环添加
                        //与当前所选人员进行对比，待选人员中过滤掉已选的人员
                        if (selectedProjectIds != '') {
                            var idsArray = selectedProjectIds.split(",");
                            var flag = true;
                            for (var k = 0; k < idsArray.length; k++) {
                                if (idsArray[k] == result.sysCustomerList[i].userId) {
                                    flag = false;
                                }
                            }
                            if (flag) {
                                $("#multiselect").append("<option value='" + result.sysCustomerList[i].id + "'>" + result.sysCustomerList[i].projectName + "</option>");
                            }
                        } else {
                            $("#multiselect").append("<option value='" + result.sysCustomerList[i].id + "'>" + result.sysCustomerList[i].projectName + "</option>");
                        }
                    }
                }
            });
        } else if (role == bgcz) {
            $.ajax({
                type: "get",
                url: ctx + "system/bgczzck/listForTree",
                traditional: true,
                dataType: "json",
                data: {},
                success: function (result) {
                    for (var i = 0; i < result.list.length; i++) {//加载未拥有的角色  这里根据后台传递的对象循环添加
                        //与当前所选人员进行对比，待选人员中过滤掉已选的人员
                        if (selectedProjectIds != '') {
                            var idsArray = selectedProjectIds.split(",");
                            var flag = true;
                            for (var k = 0; k < idsArray.length; k++) {
                                if (idsArray[k] == result.list[i].id) {
                                    flag = false;
                                }
                            }
                            if (flag) {
                                $("#multiselect").append("<option value='" + result.list[i].id + "'>" + result.list[i].projectName + "</option>");
                            }
                        } else {
                            $("#multiselect").append("<option value='" + result.list[i].id + "'>" + result.list[i].projectName + "</option>");
                        }
                    }
                }
            });
        }
        /*$.ajax({
            type: "get",
            url: ctx + "system/project/listForTree",
            traditional: true,
            dataType: "json",
            data: {},
            success: function (result) {
                for (var i = 0; i < result.sysCustomerList.length; i++) {//加载未拥有的角色  这里根据后台传递的对象循环添加
                    //与当前所选人员进行对比，待选人员中过滤掉已选的人员
                    if (selectedProjectIds != '') {
                        var idsArray = selectedProjectIds.split(",");
                        var flag = true;
                        for (var k = 0; k < idsArray.length; k++) {
                            if (idsArray[k] == result.sysCustomerList[i].userId) {
                                flag = false;
                            }
                        }
                        if (flag) {
                            $("#multiselect").append("<option value='" + result.sysCustomerList[i].customerId + "'>" + result.sysCustomerList[i].customerName + "</option>");
                        }
                    } else {
                        $("#multiselect").append("<option value='" + result.sysCustomerList[i].customerId + "'>" + result.sysCustomerList[i].customerName + "</option>");
                    }
                }
            }
        });*/
    }
</script>
</body>
</html>