<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('用户分配角色')"/>
</head>
<body>
<div class="main-content">
    <form id="form-user-add" class="form-horizontal">
        <input type="hidden" id="userId" name="userId" th:value="${user.userId}">
        <h4 class="form-header h4">基本信息</h4>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">用户名称：</label>
                    <div class="col-sm-8">
                        <input name="userName" class="form-control" type="text" disabled th:value="${user.userName}">
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label is-required">登录账号：</label>
                    <div class="col-sm-8">
                        <input name="loginName" class="form-control" type="text" disabled th:value="${user.loginName}">
                    </div>
                </div>
            </div>
        </div>

        <h4 class="form-header h4">分配角色</h4>
        <div class="row">
            <div class="col-sm-12">
                <div class="col-sm-12 select-table table-striped">
                    <table id="bootstrap-table"></table>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="row">
    <div class="col-sm-offset-5 col-sm-10">
        <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler()"><i class="fa fa-check"></i>保 存
        </button>&nbsp;
        <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><i class="fa fa-reply-all"></i>关 闭
        </button>
    </div>
</div>
<th:block th:include="include :: footer"/>
<script th:inline="javascript">
    var prefix = ctx + "system/user/authRole";
    var userRoles = [[${userRoles}]]
    var checkedIds = new Array();
    $(function () {
        console.log(getRoleIds(userRoles));
        checkedIds.push(getRoleIds(userRoles));
        var options = {
            url: ctx + "system/role/list",
            sortName: "roleSort",
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            clickToSelect: true,
            checkedIds: checkedIds,
            columns: [{
                checkbox: true,
                formatter: function (value, row, index) {
                    for (var i = 0; i < userRoles.length; i++) {
                        if (userRoles[i].roleId == row.roleId) {
                            return {checked: true};
                        }
                    }
                    return {checked: false};
                }
            },
                {
                    field: 'roleId',
                    title: '角色编号'
                },
                {
                    field: 'roleName',
                    title: '角色名称',
                    sortable: true
                },
                {
                    field: 'roleKey',
                    title: '权限字符',
                    sortable: true
                },
                {
                    field: 'createTime',
                    title: '创建时间',
                    sortable: true
                }]
        };
        $.table.init(options);
        $('#bootstrap-table').on('uncheck.bs.table check.bs.table check-all.bs.table uncheck-all.bs.table', function (e, rows) {
            var datas = $.isArray(rows) ? rows : [rows];        // 点击时获取选中的行或取消选中的行
            examine(e.type, datas);                              // 保存到全局 Array() 里
        });
        $("#bootstrap-table").on("check-all.bs.table", (event, rows) => {
            rows.forEach(function (item) {
                checkedIds.push(item.roleId);
            })
        }).on("uncheck-all.bs.table", (event, rows) => {
            rows.forEach(function (item) {
                checkedIds.splice(checkedIds.indexOf(item.roleId), 1);
            })
        }).on("check.bs.table", (event, row) => {
            checkedIds.push(row.roleId)
        }).on("uncheck.bs.table", (event, row) => {
            checkedIds.splice(checkedIds.indexOf(row.roleId), 1);
        })
    });

    function getRoleIds(userRoles) {
        var ids = new Array();
        for (var i in userRoles) {
            ids.push(userRoles[i].roleId);
        }
        return ids;
    }


    var overAllIds = new Array();  //全局数组

    function examine(type, datas) {
        if (type.indexOf('uncheck') == -1) {
            $.each(datas, function (i, v) {
                // 添加时，判断一行或多行的 id 是否已经在数组里 不存则添加　
                overAllIds.indexOf(v.roleId) == -1 ? overAllIds.push(v.roleId) : -1;
            });
        } else {
            $.each(datas, function (i, v) {
                overAllIds.splice(overAllIds.indexOf(v.roleId), 1);    //删除取消选中行
            });
        }
    }

    /* 添加角色-提交 */
    function submitHandler(index, layero) {
        console.log("ids:======" + $.common.trim(checkedIds));
        var data = {"userId": $.common.trim($("#userId").val()), "roleIds": $.common.trim(checkedIds)};
        $.operate.saveTab(prefix + "/insertAuthRole", data);
    }
</script>
</body>
</html>